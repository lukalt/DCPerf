#!/usr/bin/env python3

import math
import os

NPROC = len(os.sched_getaffinity(0))

config = {
    "port": 10086,
    "num_req_handle_threads": math.ceil(NPROC / 6),
    "num_io_handle_threads": 1,
    "num_app_logic_threads": math.ceil(NPROC * 1.5),
    "num_req_local_threads": 2,
    "num_thrift_accept_threads": 1,
    "Kernels": [
        {
            "name": "Decompress",
            "pool": "requestHandle",
            "stage": 0,
            "fanout": 96,
            "params": {
                "input": "Hdecompress{fidx}",
                "output": "Rdecompressed{fidx}",
                "compressor": "zstd",
                "level": 4,
                "size": 61440,
            },
        },
        {
            "name": "Deserialize",
            "pool": "requestHandle",
            "stage": 1,
            "fanout": 6,
            "params": {
                "input": "Hdeserialize{fidx}",
                "output": "Rdeserialized{fidx}",
                "req_vec_len": 64,
                "req_unit_list_len": 30,
                "unit_info_list_len": 16,
                "unit_i32_list_len": 13,
                "unit_list_map_size": 6,
                "niters": 15,
            },
        },
        {
            "name": "Serialize",
            "pool": "requestHandle",
            "stage": 2,
            "fanout": 6,
            "params": {
                "input": "Hserialize{fidx}",
                "output": "Rserialized{fidx}",
                "req_vec_len": 256,
                "req_unit_list_len": 16,
                "unit_info_list_len": 142,
                "unit_i32_list_len": 99,
                "unit_list_map_size": 139,
                "niters": 3,
            },
        },
        {
            "name": "IBRun",
            "pool": "applicationLogic",
            "stage": 3,
            "fanout": 4,
            "params": {"nrounds": 40000, "nmethods": 2000000},
        },
        {
            "name": "GEMM",
            "fanout": 6,
            "pool": "applicationLogic",
            "stage": 4,
            "params": {
                "M": 360,
                "N": 120,
                "K": 600,
                "niters": 1,
                "nthreads": 36,
                "input": "H45x60x600{fidx}",
            },
        },
        {
            "name": "HashMap",
            "pool": "applicationLogic",
            "stage": 5,
            "fanout": 5,
            "params": {
                "input": "f14vecmap{fidx}",
                "map_type": "f14vec",
                "runs": 988,
                "size": 6000,
            },
        },
        {
            "name": "Compress",
            "pool": "requestHandle",
            "stage": 6,
            "fanout": 64,
            "params": {
                "input": "Hcompress{fidx}",
                "output": "Rcompressed{fidx}",
                "compressor": "zstd",
                "level": 4,
                "size": 73728,
            },
        },
        {
            "name": "DeepCopy",
            "pool": "applicationLogic",
            "stage": 7,
            "params": {
                "unit_vec_len": 65536,
                "copy_len": 36,
                "i64_vec_len": 20440,
                "stri64_hashtab_size": 480,
                "stri64_map_size": 100,
                "input": "Hdeepcopy",
                "output": "Rdeepcopy",
            },
        },
        {
            "name": "DeepCopy",
            "pool": "applicationLogic",
            "stage": 8,
            "fanout": 10,
            "params": {
                "copy_len": 36,
                "input": "Rdeepcopy",
                "output": "Rdeepcopy{fidx}",
            },
        },
        {
            "name": "DeepCopy",
            "pool": "applicationLogic",
            "stage": 9,
            "fanout": 10,
            "params": {
                "copy_len": 36,
                "input": "Rdeepcopy{fidx}",
                "output": "Rdeepcopy{fidx}",
            },
        },
        {
            "name": "DeepCopy",
            "pool": "applicationLogic",
            "stage": 10,
            "fanout": 10,
            "params": {
                "copy_len": 36,
                "input": "Rdeepcopy{fidx}",
                "output": "Rdeepcopy{fidx}",
            },
        },
        {
            "name": "DeepCopy",
            "pool": "applicationLogic",
            "stage": 11,
            "fanout": 10,
            "params": {
                "copy_len": 23,
                "input": "Rdeepcopy{fidx}",
                "output": "Rdeepcopy{fidx}",
            },
        },
        {
            "name": "DeepCopy",
            "pool": "applicationLogic",
            "stage": 12,
            "fanout": 10,
            "params": {
                "copy_len": 23,
                "input": "Rdeepcopy{fidx}",
                "output": "Rdeepcopy{fidx}",
            },
        },
        {
            "name": "FakeIO",
            "pool": "IOHandle",
            "stage": 25,
            "params": {
                "quantiles": [0, 0.1, 0.5, 0.95, 0.96, 0.97, 0.98, 0.99, 1],
                "latencies": [
                    6000,
                    100000,
                    250000,
                    500000,
                    501000,
                    502000,
                    503000,
                    504000,
                    971000,
                ],
                "input": "Hsleep",
            },
        },
        {
            "name": "Shape",
            "pool": "IOHandle",
            "stage": 32,
            "params": {"input": "Rshape", "quantiles": [0, 1], "sizes": [1, 1]},
        },
        {
            "name": "Shape",
            "pool": "IOHandle",
            "stage": 32,
            "params": {
                "quantiles": [
                    0,
                    0.01,
                    0.02,
                    0.03,
                    0.04,
                    0.05,
                    0.06,
                    0.07,
                    0.08,
                    0.09,
                    0.1,
                    0.11,
                    0.12,
                    0.13,
                    0.14,
                    0.15,
                    0.16,
                    0.17,
                    0.18,
                    0.19,
                    0.2,
                    0.21,
                    0.22,
                    0.23,
                    0.24,
                    0.25,
                    0.26,
                    0.27,
                    0.28,
                    0.29,
                    0.3,
                    0.31,
                    0.32,
                    0.33,
                    0.34,
                    0.35,
                    0.36,
                    0.37,
                    0.38,
                    0.39,
                    0.4,
                    0.41,
                    0.42,
                    0.43,
                    0.44,
                    0.45,
                    0.46,
                    0.47,
                    0.48,
                    0.49,
                    0.5,
                    0.51,
                    0.52,
                    0.53,
                    0.54,
                    0.55,
                    0.56,
                    0.57,
                    0.58,
                    0.59,
                    0.6,
                    0.61,
                    0.62,
                    0.63,
                    0.64,
                    0.65,
                    0.66,
                    0.67,
                    0.68,
                    0.69,
                    0.7,
                    0.71,
                    0.72,
                    0.73,
                    0.74,
                    0.75,
                    0.76,
                    0.77,
                    0.78,
                    0.79,
                    0.8,
                    0.81,
                    0.82,
                    0.83,
                    0.84,
                    0.85,
                    0.86,
                    0.87,
                    0.88,
                    0.89,
                    0.9,
                    0.91,
                    0.92,
                    0.93,
                    0.94,
                    0.95,
                    0.96,
                    0.97,
                    0.98,
                    0.99,
                    1,
                ],
                "x100_sizes": [
                    10,
                    10,
                    10,
                    10,
                    10,
                    10,
                    170574,
                    237420,
                    242209,
                    295800,
                    281155,
                    252284,
                    213658,
                    213084,
                    203080,
                    242756,
                    318347,
                    388838,
                    506252,
                    637820,
                    922937,
                    1078802,
                    1137146,
                    1139016,
                    1132150,
                    1148688,
                    1163384,
                    1183056,
                    1213740,
                    1355750,
                    1580044,
                    2324544,
                    2975864,
                    4131982,
                    5389530,
                    6865380,
                    8078038,
                    9521250,
                    10940109,
                    12083560,
                    13268472,
                    14236244,
                    14821182,
                    15330276,
                    15768100,
                    16052966,
                    16306591,
                    16622664,
                    16910864,
                    17165750,
                    17386534,
                    17599492,
                    17794940,
                    17983262,
                    18225945,
                    18537948,
                    18788858,
                    18923780,
                    19198762,
                    19540460,
                    19897672,
                    20069838,
                    20235828,
                    20384620,
                    20416920,
                    20416502,
                    20252982,
                    20013324,
                    19718634,
                    19201810,
                    18935601,
                    18592180,
                    18234703,
                    17708962,
                    17465275,
                    17026928,
                    16781044,
                    16559056,
                    16326558,
                    16179160,
                    16166174,
                    15820910,
                    15694075,
                    15361776,
                    14965570,
                    14603678,
                    14188032,
                    13916092,
                    13502148,
                    12892180,
                    12360513,
                    11892160,
                    11237878,
                    10336442,
                    9125740,
                    8065140,
                    6327135,
                    4359730,
                    1246405,
                    94801900,
                ],
                "sizes": [
                    1,
                    1,
                    1,
                    1,
                    1,
                    1,
                    1,
                    1705,
                    2374,
                    2422,
                    2958,
                    2811,
                    2522,
                    2136,
                    2130,
                    2030,
                    2427,
                    3183,
                    3888,
                    5062,
                    6378,
                    9229,
                    10788,
                    11371,
                    11390,
                    11321,
                    11486,
                    11633,
                    11830,
                    12137,
                    13557,
                    15800,
                    23245,
                    29758,
                    41319,
                    53895,
                    68653,
                    80780,
                    95212,
                    109401,
                    120835,
                    132684,
                    142362,
                    148211,
                    153302,
                    157681,
                    160529,
                    163065,
                    166226,
                    169108,
                    171657,
                    173865,
                    175994,
                    177949,
                    179832,
                    182259,
                    185379,
                    187888,
                    189237,
                    191987,
                    195404,
                    198976,
                    200698,
                    202358,
                    203846,
                    204169,
                    204165,
                    202529,
                    200133,
                    197186,
                    192018,
                    189356,
                    185921,
                    182347,
                    177089,
                    174652,
                    170269,
                    167810,
                    165590,
                    163265,
                    161791,
                    161661,
                    158209,
                    156940,
                    153617,
                    149655,
                    146036,
                    141880,
                    139160,
                    135021,
                    128921,
                    123605,
                    118921,
                    112378,
                    103364,
                    91257,
                    80651,
                    63271,
                    43597,
                    12464,
                    948019,
                ],
            },
        },
    ],
}
